---
  - name: Install keepalived
    apt:
      name: keepalived

  - name: Copy keepalived file
    template:
      src: keepalived.conf.j2
      dest: /etc/keepalived/keepalived.conf
    notify: Restart keepalived

  - name: Create keepalivedscript user
    ansible.builtin.user:
      name: keepalived_script

  - name: Copy script
    template:
      src: keepalivedscript.j2
      dest: /home/keepalived_script/keepalived_script
      owner: keepalived_script
      mode: 0755

  - name: Ensure that keepalived is running
    service:
      name: keepalived
      state: started
      enabled: yes

  - name: Dowload keepalived-exporter
    unarchive:
      src: https://github.com/cafebazaar/keepalived-exporter/releases/download/v1.1.0/keepalived-exporter-1.1.0.linux-amd64.tar.gz
      dest: /usr/local/bin/
      remote_src: yes

  - name: Ð¡opy Keepalived-exporter
    copy:
      src: /usr/local/bin/keepalived-exporter-1.1.0.linux-amd64/keepalived-exporter
      dest: /usr/local/bin/prometheus-keepalived-exporter
      remote_src: yes
      mode: 0755

  - name: Copy conf
    copy:
      src: prometheus-keepalived-exporter.service
      dest: /etc/systemd/system/prometheus-keepalived-exporter.service
    notify:
      - Restart prometheus-keepalived-exporter
      - Reload systemd

  - name: Start and enable keepalived exporter
    service:
      name: prometheus-keepalived-exporter
      state: started
      enabled: yes
